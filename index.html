<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AR家具配置アプリ (ECS完全版)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <script src="//cdn.8thwall.com/web/ecs/ecs.js"></script>
  <script src="//cdn.8thwall.com/web/h3d/h3d.js"></script>

  <style>
    body {
      margin: 0;
      background-color: #1A202C;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
    }
    canvas { display: block; }
    h3d-scene { z-index: 200; }
    #title-container {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 5;
      width: 90%;
    }
    #title-container h1 {
      font-size: 2.2rem;
      font-weight: bold;
      line-height: 1.4;
      color: white;
      text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    #ios-ar-container {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 5;
      width: 90%;
    }
    #ios-ar-links {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
      align-items: center;
    }
    #ios-ar-links a {
      display: block;
      padding: 14px 24px;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      border-radius: 9999px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-weight: bold;
      font-size: 16px;
      min-width: 220px;
      box-sizing: border-box;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #ARButton {
      color: white !important;
      background-color: rgba(255, 255, 255, 0.2) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      border-radius: 9999px !important;
      font-size: 16px !important;
      font-weight: bold !important;
      padding: 14px 24px !important;
      min-width: 220px !important;
      box-shadow: none !important;
      opacity: 1 !important;
      position: absolute !important;
      bottom: 15% !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      z-index: 100 !important;
      white-space: nowrap !important;
    }
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: auto;
    }
    #instruction-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 16px;
      text-align: center;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 20px 30px;
      border-radius: 15px;
      line-height: 1.7;
      display: none;
      pointer-events: none;
      min-width: 260px;
      box-sizing: border-box;
    }

    #bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 220px;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 80px;
      box-sizing: border-box;
    }

    #transform-controls, #decision-controls {
      display: none;
      align-items: center;
      pointer-events: auto;
      width: 90%;
      max-width: 400px;
      justify-content: center;
    }

    #transform-controls {
      gap: 15px;
      margin-bottom: 20px;
    }
    #decision-controls {
      background-color: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 9999px;
      overflow: hidden;
      width: auto;
    }

    #scale-slider-container {
      width: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 48px;
      background-color: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 9999px;
      padding: 0 10px;
    }
    .slider-icon {
      font-size: 24px;
      font-weight: bold;
      color: rgba(255, 255, 255, 0.7);
      padding: 0 8px;
    }
    #slider-track {
      width: 100%;
      height: 6px;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      position: relative;
    }
    #slider-handle {
      width: 32px;
      height: 32px;
      background-color: white;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s ease;
    }
    .rotation-button-group {
      display: flex;
      background-color: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 9999px;
      overflow: hidden;
    }
    .group-button {
      background: none;
      border: none;
      color: white;
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .group-button:active {
      background-color: rgba(255, 255, 255, 0.2);
    }
    #delete-button, #confirm-button {
      padding: 16px 28px;
    }
    #delete-button {
      border-right: 1px solid rgba(255, 255, 255, 0.3);
    }
    #rotate-right-button {
      border-left: 1px solid rgba(255, 255, 255, 0.3);
    }

    .rotation-button-group .group-button svg {
      transform: rotate(180deg);
    }

    #add-button, #edit-button {
      position: absolute;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      align-items: center;
      pointer-events: auto;
    }
    .circle-button {
      width: 64px;
      height: 64px;
      background-color: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: transform 0.1s ease, background-color 0.2s ease;
      pointer-events: auto;
      flex-shrink: 0;
      user-select: none;
      -webkit-user-select: none;
    }
    #mode-switch-button {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 9999px;
      padding: 5px;
      font-size: 15px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      gap: 5px;
      pointer-events: auto;
      white-space: nowrap;
      transition: opacity 0.2s ease;
    }
    .mode-label {
      transition: all 0.3s ease-in-out;
      padding: 5px 15px;
      border-radius: 9999px;
      font-weight: normal;
      color: #a0aec0;
      background-color: transparent;
    }
    .mode-label.active {
      font-weight: bold;
      color: #1A202C;
      background-color: white;
    }

    #top-left-controls {
      position: absolute;
      top: 40px;
      left: 20px;
      z-index: 11;
    }
    #top-right-controls {
      position: absolute;
      top: 40px;
      right: 20px;
      z-index: 11;
    }
    #help-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 300;
      pointer-events: auto;
    }
    #help-content-container {
      background-color: rgba(45, 55, 72, 0.85);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 20px;
      border-radius: 20px;
      width: 90%;
      max-width: 520px;
      height: 580px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
    }
    #close-help-button {
      position: absolute;
      bottom: -70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: white;
      cursor: pointer;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      font-size: 28px;
      line-height: 48px;
      text-align: center;
      z-index: 15;
    }
    .help-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 15px;
      flex-shrink: 0;
    }
    .help-tab-button {
      flex-grow: 1;
      padding: 10px;
      background-color: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #A0AECB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    .help-tab-button.active {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
    }
    .help-page-content {
      overflow-y: auto;
      padding-right: 10px;
      flex: 1;
      min-height: 0;
    }
    .help-page {
      display: none;
    }
    .help-page.active {
      display: block;
    }
    .help-section {
      margin-bottom: 25px;
    }
    .help-section:last-child {
      margin-bottom: 0;
    }
    .help-section h3 {
      margin: 0 0 15px 5px;
      color: #A0AECB;
      font-size: 1rem;
    }
    .help-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 15px;
    }
    .help-card {
      background-color: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 8px;
    }
    .help-card .icon-container {
      width: 48px;
      height: 48px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #CBD5E0;
      margin-bottom: 5px;
    }
    .help-card .icon-container svg {
      width: 100%;
      height: 100%;
    }
    .help-card h4 {
      margin: 0;
      font-size: 0.9rem;
      color: white;
      line-height: 1.3;
    }
    .help-card p {
      margin: 0;
      font-size: 0.75rem;
      color: #A0AECB;
      line-height: 1.4;
    }
    .gesture-svg {
      stroke: #CBD5E0;
      fill: none;
    }
    .gesture-svg .finger {
      fill: #CBD5E0;
      stroke: none;
    }
    .gesture-svg .arrow {
      fill: #CBD5E0;
    }

    .dialog-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 300;
      pointer-events: auto;
    }
    .dialog-box {
      background-color: rgba(45, 55, 72, 0.9);
      padding: 25px 35px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.2);
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .dialog-box p {
      margin: 0 0 20px 0;
      font-size: 1.1rem;
      font-weight: bold;
    }
    .dialog-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .dialog-buttons button {
      border: none;
      border-radius: 9999px;
      padding: 10px 24px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #confirm-delete-no {
      background-color: rgba(255,255,255,0.2);
      color: white;
    }
    #confirm-delete-yes {
      background-color: #E53E3E;
      color: white;
    }

    #furniture-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: flex-end;
      z-index: 250;
      padding-bottom: 15vh;
      box-sizing: border-box;
    }
    #modal-content {
      background-color: rgba(45, 55, 72, 0.85);
      width: 90%;
      max-width: 500px;
      max-height: 70vh;
      border-radius: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.3s ease-out;
      position: relative;
    }
    #modal-header {
      padding: 15px 20px 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-bottom: none;
      flex-shrink: 0;
    }
    #modal-header h2 {
      margin: 0;
      font-size: 1.2rem;
    }
    #close-modal-button {
      position: absolute;
      bottom: -70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: white;
      cursor: pointer;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      font-size: 28px;
      line-height: 48px;
      text-align: center;
    }
    #furniture-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 15px;
      padding: 20px;
      overflow-y: auto;
    }
    .grid-item {
      cursor: pointer;
      text-align: center;
      background-color: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px 10px;
      transition: background-color 0.2s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 40px;
    }
    .grid-item:hover {
      background-color: rgba(255,255,255,0.15);
    }
    .grid-item img {
      display: none;
    }
    .grid-item p {
      margin: 0;
      font-size: 1rem;
      font-weight: bold;
      color: #E2E8F0;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div id="overlay">
    <div id="title-container">
      <h1>AR家具配置<br>シミュレーション</h1>
    </div>

    <div id="help-modal">
      <div id="help-content-container">
        <button id="close-help-button">&times;</button>
        <div class="help-tabs">
          <button class="help-tab-button active" data-tab="page1">基本操作</button>
          <button class="help-tab-button" data-tab="page2">家具の操作</button>
        </div>
        <div class="help-page-content">
          <div class="help-page active" id="page1">
            <div class="help-section">
              <h3>画面モード</h3>
              <div class="help-grid">
                <div class="help-card">
                  <div class="icon-container">
                    <svg viewBox="0 0 100 40"><rect x="1" y="1" width="98" height="38" rx="19" fill="rgba(0,0,0,0.5)" stroke="rgba(255,255,255,0.3)" stroke-width="2"/><rect x="3" y="3" width="46" height="34" rx="17" fill="white"/><text x="26" y="26" font-family="sans-serif" font-size="12" fill="black" font-weight="bold" text-anchor="middle">編集</text><text x="72" y="26" font-family="sans-serif" font-size="12" fill="#a0aec0" text-anchor="middle">鑑賞</text></svg>
                  </div>
                  <h4>モード切替</h4>
                  <p>「編集」「鑑賞」を切り替えます。</p>
                </div>
                <div class="help-card">
                  <div class="icon-container">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m-3-3-3-3m0 0 3-3m-3 3h12" /></svg>
                  </div>
                  <h4>AR終了</h4>
                  <p>AR体験を終了し、タイトル画面に戻ります。</p>
                </div>
              </div>
            </div>
            <div class="help-section">
              <h3>編集モードの基本</h3>
              <div class="help-grid">
                <div class="help-card">
                  <div class="icon-container">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                  </div>
                  <h4>家具の追加</h4>
                  <p>「+」ボタンから配置したい家具を選択します。</p>
                </div>
                <div class="help-card">
                  <div class="icon-container">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>
                  </div>
                  <h4>家具の編集</h4>
                  <p>家具を狙うと出るボタンで再選択できます。</p>
                </div>
                <div class="help-card">
                  <div class="icon-container">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>
                  </div>
                  <h4>一覧に戻る</h4>
                  <p>家具選択画面に戻ります。</p>
                </div>
              </div>
            </div>
          </div>
          <div class="help-page" id="page2">
            <div class="help-section">
              <h3>配置場所の確認</h3>
              <div class="help-grid">
                <div class="help-card">
                  <div class="icon-container">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><circle cx="12" cy="12" r="7.5" /></svg>
                  </div>
                  <h4>配置できます</h4>
                  <p>地面に輪が表示されている場所に置けます。</p>
                </div>
                <div class="help-card">
                  <div class="icon-container" style="color: #f56565;">
                    <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>
                  </div>
                  <h4>配置できません</h4>
                  <p>❌印の場所には置けません。</p>
                </div>
              </div>
            </div>
            <div class="help-section">
              <h3>ジェスチャー操作</h3>
              <div class="help-grid">
                <div class="help-card">
                  <div class="icon-container">
                    <svg viewBox="0 0 48 48" class="gesture-svg">
                      <defs><path id="arc-path" d="M8,34 A16,16 0 0,1 40,34" fill="none"/></defs>
                      <path d="M12,12 h24 v24 h-24z" stroke-width="1" opacity="0.5"/>
                      <use href="#arc-path" stroke-dasharray="4 4" stroke-width="1.5" opacity="0.7"/>
                      <circle cx="24" cy="23" r="5" class="finger" />
                      <path d="M7 32 L10 35 L13 32 Z" class="arrow"/>
                    </svg>
                  </div>
                  <h4>回転</h4>
                  <p>1本指で家具を左右にドラッグして回します。</p>
                </div>
                <div class="help-card">
                  <div class="icon-container">
                    <svg viewBox="0 0 48 48" class="gesture-svg">
                      <circle cx="18" cy="30" r="5" class="finger"/>
                      <circle cx="30" cy="18" r="5" class="finger"/>
                      <path d="M21,27 l-4,-4" stroke-width="1.5" stroke-dasharray="3 3"/>
                      <path d="M15,21 l-3,-1 l2,3" class="arrow" />
                      <path d="M27,21 l4,4" stroke-width="1.5" stroke-dasharray="3 3"/>
                      <path d="M33,27 l3,1 l-2,-3" class="arrow"/>
                    </svg>
                  </div>
                  <h4>拡大・縮小</h4>
                  <p>2本指で広げたりつまんでサイズ変更。</p>
                </div>
                <div class="help-card">
                  <div class="icon-container">
                    <svg viewBox="0 0 48 48" class="gesture-svg">
                      <path d="M14,18 h20 v12 h-20z" stroke-width="1" opacity="0.5"/>
                      <circle cx="24" cy="24" r="5" class="finger"/>
                      <circle cx="24" cy="24" r="9" stroke-width="1.5" stroke-dasharray="2 4" opacity="0.9" />
                    </svg>
                  </div>
                  <h4>長押しで削除</h4>
                  <p>家具を長押しすると削除の確認ができます。</p>
                </div>
              </div>
            </div>
            <div class="help-section">
              <h3>ボタン操作</h3>
              <div class="help-grid">
                <div class="help-card">
                  <div class="icon-container">
                    <svg viewBox="0 0 48 48" stroke="#CBD5E0" fill="none">
                      <text x="2" y="32" font-family="sans-serif" font-size="20" font-weight="bold" stroke="none" fill="#CBD5E0">-</text>
                      <rect x="13" y="22" width="22" height="4" rx="2" stroke="none" fill="rgba(255,255,255,0.4)"></rect>
                      <circle cx="24" cy="24" r="6" stroke-width="2" fill="white"></circle>
                      <text x="36" y="32" font-family="sans-serif" font-size="20" font-weight="bold" stroke="none" fill="#CBD5E0">+</text>
                    </svg>
                  </div>
                  <h4>サイズ変更</h4>
                  <p>スライダーを動かして家具の大きさを変更します。</p>
                </div>
                <div class="help-card">
                  <div class="icon-container">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="transform: rotate(180deg);">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3" />
                    </svg>
                  </div>
                  <h4>回転</h4>
                  <p>タップで45度、長押しで連続回転します。</p>
                </div>
                <div class="help-card">
                  <div class="icon-container">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                  </div>
                  <h4>配置の確定</h4>
                  <p>家具の位置や向き、大きさを決定します。</p>
                </div>
                <div class="help-card">
                  <div class="icon-container">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.134H8.09a2.09 2.09 0 0 0-2.09 2.134v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                  </div>
                  <h4>削除</h4>
                  <p>選択中の家具をシーンから削除します。</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="instruction-text">
      <span style="font-size: 1.25em; font-weight: bold;">床を認識中<span id="loading-dots"></span></span><br><br>
      カメラをゆっくりと<br>床に向けて<br>動かしてください
    </div>

    <button id="mode-switch-button">
      <span id="edit-mode-label" class="mode-label">編集モード</span>
      <span id="view-mode-label" class="mode-label">鑑賞モード</span>
    </button>

    <div id="top-left-controls">
      <button id="help-button" class="circle-button" style="display: none; width: 56px; height: 56px;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" style="width: 28px; height: 28px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
        </svg>
      </button>
    </div>
    <div id="top-right-controls">
      <button id="exit-ar-button" class="circle-button" style="display: none; width: 56px; height: 56px;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" style="width: 28px; height: 28px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m-3-3-3-3m0 0 3-3m-3 3h12" />
        </svg>
      </button>
    </div>

    <div id="bottom-bar">
      <button id="add-button" class="circle-button">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" style="width: 32px; height: 32px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
      </button>
      <button id="edit-button" class="circle-button">
         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>
      </button>

      <div id="transform-controls">
        <div id="scale-slider-container">
          <span class="slider-icon">-</span>
          <div id="slider-track">
            <div id="slider-handle"></div>
          </div>
          <span class="slider-icon">+</span>
        </div>
        <div class="rotation-button-group">
          <button id="rotate-left-button" class="group-button">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" /></svg>
          </button>
          <button id="rotate-right-button" class="group-button">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3" /></svg>
          </button>
        </div>
      </div>
      <div id="decision-controls">
        <button id="delete-button" class="group-button">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.134H8.09a2.09 2.09 0 0 0-2.09 2.134v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
        </button>
        <button id="confirm-button" class="group-button">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
        </button>
      </div>
    </div>

    <div id="confirm-dialog" class="dialog-container">
      <div class="dialog-box">
        <p>この家具を削除しますか？</p>
        <div class="dialog-buttons">
          <button id="confirm-delete-no">いいえ</button>
          <button id="confirm-delete-yes">はい</button>
        </div>
      </div>
    </div>

    <div id="furniture-modal">
      <div id="modal-content">
        <div id="modal-header">
          <h2>家具を選択</h2>
          <button id="close-modal-button">&times;</button>
        </div>
        <div id="furniture-grid">
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    // 部品①: coaching-overlay (床認識の案内役)
    ecs.registerComponent({
      name: 'coaching-overlay',
      schema: {
        uiElement: ecs.type.string, // 操作するUI要素のID
      },
      stateMachine: ({ world, eid, schemaAttribute }) => {
        const { uiElement } = schemaAttribute.get(eid)
        const instructionEl = document.getElementById(uiElement)
        let dotAnimationTimer = null

        const startDotAnimation = () => {
          if (dotAnimationTimer || !instructionEl) return;
          const dotsElement = instructionEl.querySelector('#loading-dots');
          if (!dotsElement) return;
          let dotCount = 0;
          const dots = ['・', '・・', '・・・'];
          dotAnimationTimer = setInterval(() => {
            dotsElement.textContent = dots[dotCount % dots.length];
            dotCount++;
          }, 400);
        }

        const stopDotAnimation = () => {
          if (dotAnimationTimer) {
            clearInterval(dotAnimationTimer);
            dotAnimationTimer = null;
          }
        }

        ecs.defineState('default')
          .initial()
          .listen(world.events.globalId, 'reality.trackingstatus', (e) => {
            if (e.data.status === 'LIMITED' && instructionEl) {
              instructionEl.style.display = 'block'
              startDotAnimation()
            } else if (e.data.status === 'NORMAL' && instructionEl) {
              instructionEl.style.display = 'none'
              stopDotAnimation()
            }
          })
      },
    })

    // 部品②: tap-to-place (タップで家具を配置する係)
    ecs.registerComponent({
      name: 'tap-to-place',
      data: {
        canPlace: false,
        activePrefabId: null,
      },
      stateMachine: ({ world, eid, dataAttribute }) => {
        const toCooldown = ecs.defineTrigger()

        // アプリの司令塔(app-state-manager)からの指示を受け取る
        const onPrefabSelected = (e) => {
          dataAttribute.set(eid, { activePrefabId: e.data.prefabId, canPlace: true })
        }
        const onPlacementConfirmed = () => {
          dataAttribute.set(eid, { activePrefabId: null, canPlace: false })
        }

        ecs.defineState('waiting')
          .initial()
          .listen(world.events.globalId, 'furniture.selected', onPrefabSelected)
          .listen(world.events.globalId, 'furniture.placed', onPlacementConfirmed)
          .listen(world.events.globalId, 'furniture.canceled', onPlacementConfirmed)
          .onTrigger(toCooldown, 'cooldown')

        ecs.defineState('cooldown')
          .wait(500, 'waiting')

        // スクリーンへのタッチイベント
        ecs.defineState('touch-handler')
          .listen(world.events.globalId, ecs.input.SCREEN_TOUCH_START, (e) => {
            const { canPlace, activePrefabId } = dataAttribute.get(eid)
            if (canPlace && activePrefabId) {
              const { worldPosition, worldRotation } = e.data
              const newInstance = world.createEntity(activePrefabId)

              ecs.Position.set(world, newInstance, worldPosition)
              ecs.Rotation.set(world, newInstance, worldRotation)

              world.eventio.send(newInstance, 'object.selected')
              world.eventio.send(world.events.globalId, 'furniture.placed')
              toCooldown.trigger()
            }
          })
      },
    })

    // 部品③: gesture-transform (ジェスチャーで家具を操作する職人)
    ecs.registerComponent({
      name: 'gesture-transform',
      schema: {
        minScale: ecs.type.f32,
        maxScale: ecs.type.f32,
      },
      schemaDefaults: {
        minScale: 0.5,
        maxScale: 2.0,
      },
      stateMachine: ({ world, eid, schemaAttribute }) => {
        const { minScale, maxScale } = schemaAttribute.get(eid)
        const onRotate = (e) => {
          const rotation = ecs.Rotation.get(world, eid)
          rotation.y += e.data.r
          ecs.Rotation.set(world, eid, rotation)
        }
        const onPinch = (e) => {
          const scale = ecs.Scale.get(world, eid)
          let newScale = scale.x * e.data.s
          newScale = Math.max(minScale, Math.min(maxScale, newScale))
          ecs.Scale.set(world, eid, { x: newScale, y: newScale, z: newScale })
        }
        ecs.defineState('default').initial()
          .listen(eid, ecs.gestures.ONE_FINGER_DRAG, onRotate)
          .listen(eid, ecs.gestures.PINCH, onPinch)
      },
    })

    // 部品④: object-controller (家具の選択/確定を管理) & 部品⑤: longpress-delete (長押しで削除)
    ecs.registerComponent({
      name: 'object-controller',
      stateMachine: ({ world, eid }) => {
        let longPressTimer
        const onTouchStart = () => {
          clearTimeout(longPressTimer)
          longPressTimer = setTimeout(() => {
            world.eventio.send(world.events.globalId, 'ui.confirmDelete', { targetId: eid })
          }, 800)
        }
        const onTouchEnd = () => clearTimeout(longPressTimer)
        const onTouchMove = () => clearTimeout(longPressTimer)

        const onSelected = () => {
          const children = ecs.Children.get(world, eid)
          const highlightRing = children.find(c => ecs.Name.get(world, c)?.name === 'highlight-ring')
          if (highlightRing) ecs.Hidden.remove(world, highlightRing)
          world.eventio.send(world.events.globalId, 'ui.showTransformControls', { targetId: eid })
        }
        const onConfirmed = () => {
          const children = ecs.Children.get(world, eid)
          const highlightRing = children.find(c => ecs.Name.get(world, c)?.name === 'highlight-ring')
          if (highlightRing) ecs.Hidden.set(world, highlightRing)
        }

        ecs.defineState('default').initial()
          .listen(eid, 'object.selected', onSelected)
          .listen(eid, 'object.confirmed', onConfirmed)
          .listen(eid, ecs.input.TOUCH_START, onTouchStart)
          .listen(eid, ecs.input.TOUCH_END, onTouchEnd)
          .listen(eid, ecs.input.TOUCH_MOVE, onTouchMove)
      },
    })

    // 部品⑥: app-state-manager (アプリ全体の司令塔)
    ecs.registerComponent({
      name: 'app-state-manager',
      data: {
        mode: 'edit',
        selectedObject: null,
      },
      stateMachine: ({ world, eid, dataAttribute }) => {
        const ui = {
          addButton: document.getElementById('add-button'),
          furnitureModal: document.getElementById('furniture-modal'),
          closeModalButton: document.getElementById('close-modal-button'),
          furnitureGrid: document.getElementById('furniture-grid'),
          transformControls: document.getElementById('transform-controls'),
          decisionControls: document.getElementById('decision-controls'),
          deleteButton: document.getElementById('delete-button'),
          confirmButton: document.getElementById('confirm-button'),
          confirmDialog: document.getElementById('confirm-dialog'),
          confirmDeleteYes: document.getElementById('confirm-delete-yes'),
          confirmDeleteNo: document.getElementById('confirm-delete-no'),
          modeSwitchButton: document.getElementById('mode-switch-button'),
          editModeLabel: document.getElementById('edit-mode-label'),
          viewModeLabel: document.getElementById('view-mode-label'),
          helpButton: document.getElementById('help-button'),
          helpModal: document.getElementById('help-modal'),
          closeHelpButton: document.getElementById('close-help-button'),
          helpTabs: document.querySelectorAll('.help-tab-button'),
          helpPages: document.querySelectorAll('.help-page'),
          exitArButton: document.getElementById('exit-ar-button'),
        }

        const furnitureData = [
          { name: 'イス', prefabId: 'chair-prefab' },
          { name: '本棚', prefabId: 'bookshelf-prefab' },
          { name: '脚立', prefabId: 'stand-prefab' },
        ];

        const setupUI = () => {
          ui.addButton.style.display = 'flex'
          ui.transformControls.style.display = 'none'
          ui.decisionControls.style.display = 'none'
          ui.modeSwitchButton.style.display = 'flex';
          ui.helpButton.style.display = 'flex';
          ui.exitArButton.style.display = 'flex';

          ui.addButton.onclick = () => { ui.furnitureModal.style.display = 'flex' }
          ui.closeModalButton.onclick = () => { ui.furnitureModal.style.display = 'none' }
          
          ui.furnitureGrid.innerHTML = '' // Clear previous items
          furnitureData.forEach(item => {
            const gridItem = document.createElement('div');
            gridItem.className = 'grid-item';
            gridItem.innerHTML = `<p>${item.name}</p>`
            gridItem.onclick = () => {
              world.eventio.send(world.events.globalId, 'furniture.selected', { prefabId: item.prefabId })
              ui.furnitureModal.style.display = 'none'
            }
            ui.furnitureGrid.appendChild(gridItem)
          })

          ui.modeSwitchButton.onclick = () => {
            if (dataAttribute.get(eid).selectedObject) return; // Don't switch while editing
            const current = dataAttribute.get(eid).mode
            const next = current === 'edit' ? 'view' : 'edit'
            dataAttribute.set(eid, { mode: next })
            updateUIMode(next)
          }

          ui.confirmButton.onclick = () => {
            const { selectedObject } = dataAttribute.get(eid)
            if (selectedObject) {
              world.eventio.send(selectedObject, 'object.confirmed')
              dataAttribute.set(eid, { selectedObject: null })
              ui.transformControls.style.display = 'none'
              ui.decisionControls.style.display = 'none'
              ui.addButton.style.display = 'flex'
            }
          }
          ui.deleteButton.onclick = () => {
            const { selectedObject } = dataAttribute.get(eid)
            if (selectedObject) ui.confirmDialog.style.display = 'flex'
          }

          ui.confirmDeleteYes.onclick = () => {
            const { selectedObject } = dataAttribute.get(eid)
            if (selectedObject) world.removeEntity(selectedObject)
            dataAttribute.set(eid, { selectedObject: null })
            ui.confirmDialog.style.display = 'none'
            ui.transformControls.style.display = 'none'
            ui.decisionControls.style.display = 'none'
            ui.addButton.style.display = 'flex'
          }
          ui.confirmDeleteNo.onclick = () => {
            ui.confirmDialog.style.display = 'none'
          }

          ui.helpButton.onclick = () => { ui.helpModal.style.display = 'flex' }
          ui.closeHelpButton.onclick = () => { ui.helpModal.style.display = 'none' }
          ui.exitArButton.onclick = () => { XR8.stop() }

          ui.helpTabs.forEach(button => {
            button.addEventListener('click', () => {
              const targetTab = button.dataset.tab;
              ui.helpTabs.forEach(btn => btn.classList.remove('active'));
              button.classList.add('active');
              ui.helpPages.forEach(page => page.classList.toggle('active', page.id === targetTab));
            });
          });
        }

        const updateUIMode = (mode) => {
          const isEditing = dataAttribute.get(eid).selectedObject !== null
          if (mode === 'edit') {
            ui.editModeLabel.classList.add('active')
            ui.viewModeLabel.classList.remove('active')
            if (!isEditing) ui.addButton.style.display = 'flex'
          } else { // view mode
            ui.editModeLabel.classList.remove('active')
            ui.viewModeLabel.classList.add('active')
            ui.addButton.style.display = 'none'
            ui.transformControls.style.display = 'none'
            ui.decisionControls.style.display = 'none'
            const { selectedObject } = dataAttribute.get(eid)
            if (selectedObject) {
              world.eventio.send(selectedObject, 'object.confirmed')
              dataAttribute.set(eid, { selectedObject: null })
            }
          }
        }

        const onShowTransformControls = (e) => {
          const { mode } = dataAttribute.get(eid)
          if (mode === 'edit') {
            const { selectedObject } = dataAttribute.get(eid)
            if (selectedObject && selectedObject !== e.data.targetId) {
               world.eventio.send(selectedObject, 'object.confirmed')
            }
            dataAttribute.set(eid, { selectedObject: e.data.targetId })
            ui.transformControls.style.display = 'flex'
            ui.decisionControls.style.display = 'flex'
            ui.addButton.style.display = 'none'
          }
        }
        const onConfirmDelete = (e) => {
          const { mode } = dataAttribute.get(eid)
          if (mode === 'edit') {
            dataAttribute.set(eid, { selectedObject: e.data.targetId })
            ui.confirmDialog.style.display = 'flex'
          }
        }
        
        ecs.defineState('init')
          .initial()
          .invoke(setupUI)
          .listen(world.events.globalId, 'ui.showTransformControls', onShowTransformControls)
          .listen(world.events.globalId, 'ui.confirmDelete', onConfirmDelete)
      },
    })
  </script>

  <h3d-scene>
    <h3d-camera id="camera" position="0 1.6 0"></h3d-camera>
    <h3d-light type="hemisphere" sky-color="#ffffff" ground-color="#bbbbff" intensity="3"></h3d-light>

    <h3d-entity id="system">
      <ecs-coaching-overlay ui-element="instruction-text"></ecs-coaching-overlay>
      <ecs-app-state-manager></ecs-app-state-manager>
      <ecs-tap-to-place></ecs-tap-to-place>
    </h3d-entity>

    <h3d-entity id="chair-prefab" ecs.hidden>
      <h3d-model src="chair.glb"></h3d-model>
      <ecs.layers.touchable></ecs.layers.touchable>
      <ecs-gesture-transform></ecs-gesture-transform>
      <ecs-object-controller></ecs-object-controller>
      <h3d-entity ecs.name="highlight-ring" ecs.hidden>
        <h3d-ring radius-inner="0.4" radius-outer="0.45" rotation="90 0 0" material-id="highlight-mat"></h3d-ring>
      </h3d-entity>
    </h3d-entity>

    <h3d-entity id="bookshelf-prefab" ecs.hidden>
      <h3d-model src="bookshelf.glb"></h3d-model>
      <ecs.layers.touchable></ecs.layers.touchable>
      <ecs-gesture-transform min-scale="0.3" max-scale="1.5"></ecs-gesture-transform>
      <ecs-object-controller></ecs-object-controller>
      <h3d-entity ecs.name="highlight-ring" ecs.hidden>
         <h3d-ring radius-inner="0.6" radius-outer="0.7" rotation="90 0 0" material-id="highlight-mat"></h3d-ring>
      </h3d-entity>
    </h3d-entity>

    <h3d-entity id="stand-prefab" ecs.hidden>
      <h3d-model src="stand.glb"></h3d-model>
      <ecs.layers.touchable></ecs.layers.touchable>
      <ecs-gesture-transform></ecs-gesture-transform>
      <ecs-object-controller></ecs-object-controller>
       <h3d-entity ecs.name="highlight-ring" ecs.hidden>
        <h3d-ring radius-inner="0.5" radius-outer="0.55" rotation="90 0 0" material-id="highlight-mat"></h3d-ring>
      </h3d-entity>
    </h3d-entity>

    <h3d-material id="highlight-mat" type="standard" color="white" emissive="white" emissive-intensity="1"></h3d-material>

  </h3d-scene>

</body>
</html>
